## 概述

代理



### 负载均衡

#### 类型

- 将单一的重负载分担到多个网络节点上做并行处理，每个节点处理结束后将结果汇总返回给用户，提高网络系统处理能力
- 将大量前端并发访问或数据流量分担到多个后端网络节点上处理，减少用户等待时间

#### 策略

- 内置策略

  - 轮询

  按顺序逐一分配到不同的后端节点，对于出现问题的节点排除

  - 加权轮询

  在基本的轮询策略上考虑后端节点接受请求的权重，指定各后端节点被轮到的概率

  - IP hash

  将前端访问的IP进行Hash操作，根据Hash结果分配给不同的后端节点

- 扩展策略

  通过第三方模块实现，种类丰富，常见的有url hash、fair等

  - url hash 

  对前端访问的url进行hash操作、

  - fair

  从另一角度实现负载均衡，将前端请求转发到一个最近负载最小的后台节点，根据后端节点对请求的响应时间来判断负载情况，响应时间短则负载就轻

### web缓存

## 配置文件介绍

### 配置文件结构

nginx服务器配置文件存在安装目录conf中，主配置文件为nginx.conf

结构：

- 全局块

​        默认配置文件从开始到events块之间的一部分内容，主要设置一些影响nginx服务器整体运行的配置指令，这些指令作用域是nginx服务器全局

​        通常包括配置运行Nginx服务器的用户（组）,允许生成的worker process数，nginx进程PID存放路径，日志的存放路径和类型以及配置文件的引入

- events块

​          events块涉及的指令主要影响Nginx服务器与用户的网络连接，常用到的设置包括是否开启对多worker process下的网络连接进行序列化，选取哪种事件驱动模型处理连接请求，每个worker process可以同时支持的最大连接数等

- http块

  配置代理、缓存和日志等绝大多数的功能和第三方模块的配置

  - http全局块	配置文件引入、MIMI-Type定义、日志自定义、是否使用sendfile传输文件，连接超时时间，单连接请求数上限

  - server块

    提供虚拟主机服务，使得Nginx服务器可以在同一台服务器上只运行一组Ninx进程，就可以运行多个网站，一个http块中可以有多个server块

    - server全局块

    - location块

      基于Nginx服务器接收到的请求字符串，对除虚拟机主机名称之外的字符串进行匹配，对特定的请求尽心处理，地址重定向、数据缓存和应答控制等功能都是在这部分实现。许多第三方模块的配置也是在location块中提供功能

### 配置文件详解

1. 配置运行Nginx服务器用户（组）
2. 配置允许生成的worker process数
3. 配置nginx进程PID存放路径
4. 配置错误日志的存放路径
5. 配置文件的引入
6. 设置网络连接的序列化
7. 设置是否允许同时接收多个网络连接
8. 事件驱动模型的选择
9. 配置最大连接数
10. 定义MIMI-Type
11. 自定义服务日志
12. 配置允许sendfile方式传输文件
13. 配置连接超时时间
14. 单连接请求数上限
15. 配置网络监听
16. 基于名称的虚拟主机配置
17. 基于IP的虚拟主机配置
18. 配置location块
19. 配置请求的根目录
20. 更改的URI
21. 设置网站的默认首页
22. 设置网站的错误页面
23. 基于IP配置Nginx的访问权限
24. 基于密码配置Nginx的访问权限
25. Nginx服务器基础配置实例



## 架构初步认识

### 模块化结构

### web请求处理机制

### 事件驱动模型

### 设计架构概览

## 高级配置

#### nginx服务器架构

​		Nginx服务器启动后，产生一个主进程，主进程进行一系列工作后产生一个或者多个工作进程（worker processes）

-  主进程：主要进行Nginx配置文件解析、数据结构初始化、模块配置和注册、信号处理、网络监听生成、工作进程生成和管理等工作
-  工作进程：进行进程初始化、模块调用和请求处理等工作，是Nginx服务器提供服务的主体
-  后端服务器：在客户端请求动态站点的过程中，Nginx服务器还涉及和后端服务器通信，Ngin服务器将受到的web请求通过代理转发到后端服务器，由后端服务器进行数据处理和页面组织，然后将结果返回
-  缓存：Nginx为了提高对请求的响应效率，进一步降低网络压力，采用了缓存机制，将历史应答数据缓存到本地，每次Nginx启动后的一段事件内，会启动专门的进程对本地缓存的内容重建索引，保证对缓存文件的快速访问。

## Gzip压缩

## Rewrite功能

## 代理功能

## 缓存机制

## 邮件机制

## 源码结构

## 基本数据结构

## 启动初始化

## 时间管理

## 内存管理

## 工作进程

## 模块编程

















## 日志管理



日志分割脚本

```shell
#!/bin/bash
# 日志保存位置
base_path='/usr/local/nginx/logs'
# 获取当前年信息和月信息
log_path=$(date -d yesterday +"%Y%m")
# 获取昨天的日信息
day=$(date -d yesterday +"%d")
# 按年月创建文件夹
mkdir -p $base_path/$log_path
# 备份昨天的日志到当月的文件夹
mv $base_path/access.log $base_path/$log_path/access_$day.log
mv $base_path/error.log $base_path/$log_path/error_$day.log

touch $base_path/access.log
touch $base_path/error.log
# 输出备份日志文件名
# echo $base_path/$log_path/access_$day.log
# 通过Nginx信号量控制重读日志
kill -SIGUSR1 `cat /usr/local/nginx/logs/nginx.pid`
exit 0
```



#### 启动脚本



#### ngx_fastdfs_module